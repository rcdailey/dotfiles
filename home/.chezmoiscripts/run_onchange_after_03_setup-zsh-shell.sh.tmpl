#!/usr/bin/env zsh
set -e

# Set up zsh as default shell after Homebrew installation
# Script hash: {{ .chezmoi.sourceFile | include | sha256sum }}

# Ensure Homebrew is available from previous script
{{- if eq .chezmoi.os "darwin" }}
[[ -f "/opt/homebrew/bin/brew" ]] && eval "$(/opt/homebrew/bin/brew shellenv)"
ZSH_PATH="/opt/homebrew/bin/zsh"
{{- else }}
[[ -f "/home/linuxbrew/.linuxbrew/bin/brew" ]] && eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
ZSH_PATH="/home/linuxbrew/.linuxbrew/bin/zsh"
{{- end }}

# Check if zsh is installed via Homebrew
if [[ ! -x "$ZSH_PATH" ]]; then
  echo "ERROR: zsh not found at $ZSH_PATH" >&2
  echo "This script should run after Homebrew installs zsh." >&2
  exit 1
fi

echo "Found zsh at: $ZSH_PATH"
echo "Version: $($ZSH_PATH --version)"

# Check if zsh is already the default shell
CURRENT_SHELL=$(basename "$SHELL" 2>/dev/null || echo "unknown")
if [[ "$SHELL" == "$ZSH_PATH" ]]; then
  echo "zsh is already the default shell"
  exit 0
fi

echo "Current shell: $CURRENT_SHELL ($SHELL)"
echo "Setting up zsh as default shell..."

# Add zsh to /etc/shells if not present
if ! grep -q "^$ZSH_PATH$" /etc/shells 2>/dev/null; then
  echo "Adding $ZSH_PATH to /etc/shells (requires sudo)..."
  if command -v sudo &>/dev/null; then
    echo "$ZSH_PATH" | sudo tee -a /etc/shells >/dev/null
    echo "Successfully added zsh to /etc/shells"
  else
    echo "WARNING: sudo not available, cannot add zsh to /etc/shells" >&2
    echo "You may need to manually run: echo '$ZSH_PATH' | sudo tee -a /etc/shells" >&2
  fi
else
  echo "zsh already present in /etc/shells"
fi

# Change default shell to zsh
echo "Changing default shell to zsh..."
if command -v chsh &>/dev/null; then
  if chsh -s "$ZSH_PATH"; then
    echo "Successfully changed default shell to zsh"
    echo "NOTE: New shell will take effect in new terminal sessions"
  else
    echo "WARNING: Failed to change default shell" >&2
    echo "You may need to manually run: chsh -s $ZSH_PATH" >&2
  fi
else
  echo "WARNING: chsh command not available" >&2
  echo "You may need to manually change your default shell" >&2
fi

echo "Zsh setup complete!"
echo "Restart your terminal or start a new session to use zsh as your default shell."
