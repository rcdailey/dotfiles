#!/usr/bin/env zsh
set -e

# Install Homebrew and ensure it's available for subsequent scripts
# Script hash: {{ .chezmoi.sourceFile | include | sha256sum }}

# Check if Homebrew is already installed
if command -v brew &>/dev/null; then
  echo "Homebrew already installed: $(brew --version | head -n1)"
  exit 0
fi

echo "Installing Homebrew..."

# Official Homebrew installation script (works on macOS and Linux)
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# Source Homebrew environment for subsequent scripts
{{- if eq .chezmoi.os "darwin" }}
if [[ -f "/opt/homebrew/bin/brew" ]]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi
{{- else }}
if [[ -f "/home/linuxbrew/.linuxbrew/bin/brew" ]]; then
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
fi
{{- end }}

# Verify installation works in current session
if command -v brew &>/dev/null; then
  echo "Homebrew installed and available: $(brew --version | head -n1)"
else
  echo "ERROR: Homebrew installation failed or not in PATH" >&2
  exit 1
fi

echo "Homebrew installation complete!"
