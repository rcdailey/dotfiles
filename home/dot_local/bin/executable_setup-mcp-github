#!/usr/bin/env zsh
set -euo pipefail

# Toolset configuration - edit this list to customize enabled toolsets
TOOLSETS="context,repos,issues,pull_requests,actions,discussions"

# Install github-mcp-server via Homebrew if not already installed
if ! command -v github-mcp-server &>/dev/null; then
  echo "Installing github-mcp-server via Homebrew..."
  brew install github-mcp-server
fi

# Get GitHub token from gh auth
if ! gh auth status &>/dev/null; then
  echo "Error: gh auth session not available. Run 'gh auth login' first." >&2
  exit 1
fi

TOKEN=$(gh auth token)
if [[ -z "$TOKEN" ]]; then
  echo "Error: Failed to retrieve token from gh auth" >&2
  exit 1
fi

# Remove existing github MCP if present
if claude mcp get github &>/dev/null; then
  echo "Removing existing github MCP server..."
  claude mcp remove github
fi

echo "Adding github MCP server with toolsets: $TOOLSETS"

claude mcp add github -s user \
  -e GITHUB_PERSONAL_ACCESS_TOKEN="$TOKEN" \
  -e GITHUB_TOOLSETS="$TOOLSETS" \
  -- github-mcp-server stdio --dynamic-toolsets


echo "GitHub MCP server configured successfully!"
echo "Run 'claude mcp get github' to verify configuration"
